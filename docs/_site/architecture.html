<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
      <title>DDAP Architecture | DDAP - Dynamic Data API Provider </title>
      <meta name="viewport" content="width=device-width, initial-scale=1.0">
      <meta name="title" content="DDAP Architecture | DDAP - Dynamic Data API Provider ">
      
      
      <link rel="icon" href="favicon.ico">
      <link rel="stylesheet" href="public/docfx.min.css">
      <link rel="stylesheet" href="public/main.css">
      <meta name="docfx:navrel" content="toc.html">
      <meta name="docfx:tocrel" content="toc.html">
      
      <meta name="docfx:rel" content="">
      
      
      <meta name="docfx:docurl" content="https://github.com/schivei/ddap/blob/main/docs/architecture.md/#L1">
      <meta name="loc:inThisArticle" content="In this article">
      <meta name="loc:searchResultsCount" content="{count} results for &quot;{query}&quot;">
      <meta name="loc:searchNoResults" content="No results for &quot;{query}&quot;">
      <meta name="loc:tocFilter" content="Filter by title">
      <meta name="loc:nextArticle" content="Next">
      <meta name="loc:prevArticle" content="Previous">
      <meta name="loc:themeLight" content="Light">
      <meta name="loc:themeDark" content="Dark">
      <meta name="loc:themeAuto" content="Auto">
      <meta name="loc:changeTheme" content="Change theme">
      <meta name="loc:copy" content="Copy">
      <meta name="loc:downloadPdf" content="Download PDF">

      <script type="module" src="./public/docfx.min.js"></script>

      <script>
        const theme = localStorage.getItem('theme') || 'auto'
        document.documentElement.setAttribute('data-bs-theme', theme === 'auto' ? (window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light') : theme)
      </script>

  </head>

  <body class="tex2jax_ignore" data-layout="" data-yaml-mime="">
    <header class="bg-body border-bottom">
      <nav id="autocollapse" class="navbar navbar-expand-md" role="navigation">
        <div class="container-xxl flex-nowrap">
          <a class="navbar-brand" href="index.html">
            <img id="logo" class="svg" src="logo.svg" alt="DDAP">
            DDAP
          </a>
          <button class="btn btn-lg d-md-none border-0" type="button" data-bs-toggle="collapse" data-bs-target="#navpanel" aria-controls="navpanel" aria-expanded="false" aria-label="Toggle navigation">
            <i class="bi bi-three-dots"></i>
          </button>
          <div class="collapse navbar-collapse" id="navpanel">
            <div id="navbar">
              <form class="search" role="search" id="search">
                <i class="bi bi-search"></i>
                <input class="form-control" id="search-query" type="search" disabled placeholder="Search" autocomplete="off" aria-label="Search">
              </form>
            </div>
          </div>
        </div>
      </nav>
    </header>

    <main class="container-xxl">

      <div class="content">
        <div class="actionbar">

          <nav id="breadcrumb"></nav>
        </div>

        <article data-uid="">
<h1 id="ddap-architecture">DDAP Architecture</h1>

<p>This document provides an overview of DDAP's architecture, design principles, and how the different components work together.</p>
<h2 id="architecture-overview">Architecture Overview</h2>
<p>DDAP follows a modular, layered architecture with clear separation of concerns:</p>
<pre><code>┌─────────────────────────────────────────────────────────┐
│                    API Layer                            │
│  ┌──────────┐  ┌──────────┐  ┌──────────┐             │
│  │   REST   │  │  GraphQL │  │   gRPC   │             │
│  └────┬─────┘  └────┬─────┘  └────┬─────┘             │
└───────┼────────────┼─────────────┼────────────────────┘
        │            │             │
┌───────┴────────────┴─────────────┴────────────────────┐
│                    Core Layer                          │
│  ┌──────────────────────────────────────────────┐     │
│  │         Entity Repository &amp; Configuration     │     │
│  └───────────────────┬──────────────────────────┘     │
└────────────────────┼───────────────────────────────────┘
                     │
┌────────────────────┴───────────────────────────────────┐
│                 Data Provider Layer                     │
│  ┌─────────┐  ┌─────────┐  ┌──────────┐  ┌─────────┐ │
│  │SqlServer│  │  MySQL  │  │PostgreSQL│  │Entity   │ │
│  │(Dapper) │  │(Dapper) │  │(Dapper)  │  │Framework│ │
│  └─────────┘  └─────────┘  └──────────┘  └─────────┘ │
└─────────────────────────────────────────────────────────┘
</code></pre>
<h2 id="core-concepts">Core Concepts</h2>
<h3 id="1-entity-configuration">1. Entity Configuration</h3>
<p>The heart of DDAP is the <code>IEntityConfiguration</code> interface, which represents metadata about database tables:</p>
<pre><code class="lang-csharp">public interface IEntityConfiguration
{
    string Name { get; }
    string Schema { get; }
    IReadOnlyList&lt;IPropertyConfiguration&gt; Properties { get; }
    IReadOnlyList&lt;IIndexConfiguration&gt; Indexes { get; }
    IReadOnlyList&lt;IRelationshipConfiguration&gt; Relationships { get; }
}
</code></pre>
<p><strong>Key Features:</strong></p>
<ul>
<li>Represents database tables/entities</li>
<li>Contains property (column) metadata</li>
<li>Includes index and relationship information</li>
<li>Supports composite keys and complex relationships</li>
</ul>
<h3 id="2-entity-repository">2. Entity Repository</h3>
<p>The <code>IEntityRepository</code> is the central registry for all entity configurations:</p>
<pre><code class="lang-csharp">public interface IEntityRepository
{
    IReadOnlyList&lt;IEntityConfiguration&gt; Entities { get; }
    IEntityConfiguration? GetEntity(string name);
    void AddEntity(IEntityConfiguration entity);
}
</code></pre>
<p><strong>Responsibilities:</strong></p>
<ul>
<li>Store and manage entity configurations</li>
<li>Provide entity lookup by name</li>
<li>Thread-safe access to entity metadata</li>
</ul>
<h3 id="3-data-provider-abstraction">3. Data Provider Abstraction</h3>
<p>The <code>IDataProvider</code> interface abstracts database-specific logic:</p>
<pre><code class="lang-csharp">public interface IDataProvider
{
    Task LoadEntitiesAsync(IEntityRepository repository);
    // Additional database operations...
}
</code></pre>
<p><strong>Benefits:</strong></p>
<ul>
<li>Database-agnostic core</li>
<li>Pluggable database support</li>
<li>Consistent API across providers</li>
</ul>
<h2 id="component-details">Component Details</h2>
<h3 id="core-package-ddapcore">Core Package (Ddap.Core)</h3>
<p><strong>Purpose:</strong> Provides abstractions and core functionality</p>
<p><strong>Key Components:</strong></p>
<ul>
<li><code>IEntityConfiguration</code> - Entity metadata interface</li>
<li><code>IPropertyConfiguration</code> - Property/column metadata</li>
<li><code>IIndexConfiguration</code> - Index metadata</li>
<li><code>IRelationshipConfiguration</code> - Foreign key relationships</li>
<li><code>IEntityRepository</code> - Entity registry</li>
<li><code>IDataProvider</code> - Database provider abstraction</li>
<li><code>IDdapBuilder</code> - Fluent configuration API</li>
</ul>
<p><strong>Design Principles:</strong></p>
<ul>
<li>Interface-based design for extensibility</li>
<li>No database-specific code</li>
<li>Minimal dependencies</li>
<li>Internal implementation classes in <code>Internals/</code> folder</li>
</ul>
<h3 id="data-provider-packages">Data Provider Packages</h3>
<p>Each database provider implements <code>IDataProvider</code> and loads database metadata:</p>
<h4 id="ddapdatadappersqlserver">Ddap.Data.Dapper.SqlServer</h4>
<ul>
<li>SQL Server metadata loading</li>
<li>Dapper-based queries</li>
<li>Supports indexes, relationships, composite keys</li>
</ul>
<h4 id="ddapdatadappermysql">Ddap.Data.Dapper.MySQL</h4>
<ul>
<li>MySQL metadata loading via INFORMATION_SCHEMA</li>
<li>Handles MySQL-specific data types</li>
<li>Full relationship and index support</li>
</ul>
<h4 id="ddapdatadapperpostgresql">Ddap.Data.Dapper.PostgreSQL</h4>
<ul>
<li>PostgreSQL metadata loading via pg_catalog</li>
<li>Supports PostgreSQL-specific features</li>
<li>UUID and array type handling</li>
</ul>
<h4 id="ddapdataentityframework">Ddap.Data.EntityFramework</h4>
<ul>
<li>Database-agnostic using EF Core</li>
<li>Uses EF's model metadata</li>
<li>Works with any EF-supported database</li>
</ul>
<h3 id="api-provider-packages">API Provider Packages</h3>
<h4 id="ddaprest">Ddap.Rest</h4>
<ul>
<li>Generates REST controllers via partial classes</li>
<li>Content negotiation (JSON/XML/YAML)</li>
<li>Uses Newtonsoft.Json for JSON serialization</li>
<li>Entity metadata endpoints</li>
</ul>
<p><strong>Endpoints Generated:</strong></p>
<pre><code>GET    /api/entity              - List all entities
GET    /api/entity/{name}       - Get entity data
GET    /api/entity/{name}/metadata - Get entity metadata
POST   /api/entity/{name}       - Create entity
PUT    /api/entity/{name}/{id}  - Update entity
DELETE /api/entity/{name}/{id}  - Delete entity
</code></pre>
<h4 id="ddapgraphql">Ddap.GraphQL</h4>
<ul>
<li>Generates GraphQL schema dynamically</li>
<li>Query and Mutation types</li>
<li>Entity metadata queries</li>
<li>Hot Chocolate integration</li>
</ul>
<p><strong>Schema Example:</strong></p>
<pre><code class="lang-graphql">type Query {
  entities: [EntityMetadata!]!
  entity(entityName: String!): EntityMetadata
}

type EntityMetadata {
  name: String!
  schema: String!
  propertyCount: Int!
}
</code></pre>
<h4 id="ddapgrpc">Ddap.Grpc</h4>
<ul>
<li>Generates gRPC services</li>
<li>Protocol buffer definitions</li>
<li>Entity CRUD operations</li>
<li>.proto file generation</li>
</ul>
<h3 id="additional-packages">Additional Packages</h3>
<h4 id="ddapmemory">Ddap.Memory</h4>
<ul>
<li>In-memory entity management</li>
<li>Testing and development support</li>
</ul>
<h4 id="ddapcodegen">Ddap.CodeGen</h4>
<ul>
<li>Source generators for compile-time code generation</li>
<li>Reduces runtime overhead</li>
<li>Generates strongly-typed entity classes</li>
</ul>
<h4 id="ddapaspire">Ddap.Aspire</h4>
<ul>
<li>.NET Aspire integration</li>
<li>Automatic service discovery</li>
<li>Connection string management</li>
<li>Auto-refresh support for schema changes</li>
</ul>
<h4 id="ddapauth">Ddap.Auth</h4>
<ul>
<li>Authentication and authorization support</li>
<li>Entity-level security</li>
<li>Integration with ASP.NET Core Identity</li>
</ul>
<h4 id="ddapsubscriptions">Ddap.Subscriptions</h4>
<ul>
<li>Real-time data updates</li>
<li>WebSocket support</li>
<li>SignalR integration</li>
<li>GraphQL subscriptions</li>
</ul>
<h2 id="design-patterns">Design Patterns</h2>
<h3 id="builder-pattern">Builder Pattern</h3>
<p>DDAP uses the builder pattern for fluent configuration:</p>
<pre><code class="lang-csharp">builder.Services
    .AddDdap(options =&gt; { /* configure */ })
    .AddSqlServerDapper()
    .AddRest()
    .AddGraphQL();
</code></pre>
<p><strong>Benefits:</strong></p>
<ul>
<li>Clear, readable configuration</li>
<li>Chainable method calls</li>
<li>Type-safe configuration</li>
</ul>
<h3 id="partial-classes">Partial Classes</h3>
<p>All generated controllers, services, and types are partial classes:</p>
<pre><code class="lang-csharp">public partial class EntityController : ControllerBase
{
    // Generated code...
}
</code></pre>
<p><strong>Benefits:</strong></p>
<ul>
<li>Easy extensibility</li>
<li>Custom logic without modifying generated code</li>
<li>Separation of concerns</li>
</ul>
<h3 id="dependency-injection">Dependency Injection</h3>
<p>All components use constructor injection:</p>
<pre><code class="lang-csharp">public class EntityController
{
    private readonly IEntityRepository _repository;
    
    public EntityController(IEntityRepository repository)
    {
        _repository = repository;
    }
}
</code></pre>
<p><strong>Benefits:</strong></p>
<ul>
<li>Testability</li>
<li>Loose coupling</li>
<li>ASP.NET Core integration</li>
</ul>
<h2 id="data-flow">Data Flow</h2>
<h3 id="startup-flow">Startup Flow</h3>
<ol>
<li><p><strong>Configuration Phase</strong></p>
<pre><code>AddDdap() → Register core services
AddSqlServerDapper() → Register data provider
AddRest() → Register REST controllers
</code></pre>
</li>
<li><p><strong>Initialization Phase</strong></p>
<pre><code>Application starts → Data provider loads metadata
→ Populates EntityRepository → APIs ready
</code></pre>
</li>
<li><p><strong>Request Handling</strong></p>
<pre><code>HTTP Request → Controller → EntityRepository
→ Returns metadata or data → Response
</code></pre>
</li>
</ol>
<h3 id="entity-loading-flow">Entity Loading Flow</h3>
<pre><code>IDataProvider.LoadEntitiesAsync()
  ↓
Query database metadata (tables, columns, indexes, relationships)
  ↓
Create IEntityConfiguration instances
  ↓
Add to IEntityRepository
  ↓
APIs can now use entity metadata
</code></pre>
<h2 id="extensibility-points">Extensibility Points</h2>
<h3 id="1-custom-controllers">1. Custom Controllers</h3>
<p>Add custom endpoints to generated controllers:</p>
<pre><code class="lang-csharp">namespace Ddap.Rest;

public partial class EntityController
{
    [HttpGet(&quot;custom/{name}&quot;)]
    public IActionResult CustomEndpoint(string name)
    {
        // Custom logic
    }
}
</code></pre>
<h3 id="2-custom-data-providers">2. Custom Data Providers</h3>
<p>Implement <code>IDataProvider</code> for new databases:</p>
<pre><code class="lang-csharp">public class MyDatabaseProvider : IDataProvider
{
    public async Task LoadEntitiesAsync(IEntityRepository repository)
    {
        // Load metadata from your database
    }
}
</code></pre>
<h3 id="3-custom-api-providers">3. Custom API Providers</h3>
<p>Create new API providers:</p>
<pre><code class="lang-csharp">public static class MyApiProviderExtensions
{
    public static IDdapBuilder AddMyApi(this IDdapBuilder builder)
    {
        // Register your services
        return builder;
    }
}
</code></pre>
<h3 id="4-source-generators">4. Source Generators</h3>
<p>Use Ddap.CodeGen for compile-time code generation:</p>
<pre><code class="lang-csharp">[DdapEntity]
public partial class MyEntity
{
    // Properties generated at compile-time
}
</code></pre>
<h2 id="performance-considerations">Performance Considerations</h2>
<h3 id="metadata-caching">Metadata Caching</h3>
<ul>
<li>Entity metadata is loaded once at startup</li>
<li>Cached in <code>IEntityRepository</code></li>
<li>No per-request metadata queries</li>
</ul>
<h3 id="code-generation">Code Generation</h3>
<ul>
<li>Source generators create code at compile-time</li>
<li>Reduces runtime reflection</li>
<li>Improves startup performance</li>
</ul>
<h3 id="dapper-vs-entity-framework">Dapper vs Entity Framework</h3>
<ul>
<li><strong>Dapper providers</strong>: Lower memory, faster queries</li>
<li><strong>EF provider</strong>: More features, slower but flexible</li>
</ul>
<h3 id="content-negotiation">Content Negotiation</h3>
<ul>
<li>Format selection happens early in pipeline</li>
<li>Newtonsoft.Json for JSON (configurable)</li>
<li>XML and YAML formatters cached</li>
</ul>
<h2 id="security">Security</h2>
<h3 id="sql-injection-protection">SQL Injection Protection</h3>
<ul>
<li>All data providers use parameterized queries</li>
<li>No string concatenation for SQL</li>
<li>Safe from SQL injection attacks</li>
</ul>
<h3 id="code-coverage-exclusion">Code Coverage Exclusion</h3>
<p>Generated code is automatically excluded from code coverage:</p>
<pre><code class="lang-xml">&lt;ExcludeFromCodeCoverage&gt;true&lt;/ExcludeFromCodeCoverage&gt;
</code></pre>
<h2 id="testing-strategy">Testing Strategy</h2>
<h3 id="unit-testing">Unit Testing</h3>
<p>Test core abstractions and interfaces:</p>
<pre><code class="lang-csharp">[Fact]
public void EntityRepository_AddEntity_StoresEntity()
{
    var repository = new EntityRepository();
    var entity = CreateTestEntity();
    
    repository.AddEntity(entity);
    
    Assert.Contains(entity, repository.Entities);
}
</code></pre>
<h3 id="integration-testing">Integration Testing</h3>
<p>Test with real databases using containers:</p>
<pre><code class="lang-csharp">[Fact]
public async Task SqlServerProvider_LoadsEntities()
{
    using var container = new SqlServerContainer();
    await container.StartAsync();
    
    var provider = new SqlServerDapperProvider(connectionString);
    var repository = new EntityRepository();
    
    await provider.LoadEntitiesAsync(repository);
    
    Assert.NotEmpty(repository.Entities);
}
</code></pre>
<h2 id="deployment">Deployment</h2>
<h3 id="nuget-packages">NuGet Packages</h3>
<p>Each component is a separate NuGet package:</p>
<ul>
<li>Install only what you need</li>
<li>Reduces deployment size</li>
<li>Clear dependency graph</li>
</ul>
<h3 id="docker-support">Docker Support</h3>
<p>Works in containers:</p>
<pre><code class="lang-dockerfile">FROM mcr.microsoft.com/dotnet/aspnet:10.0
COPY bin/Release/net10.0/publish/ /app
WORKDIR /app
ENTRYPOINT [&quot;dotnet&quot;, &quot;MyDdapApi.dll&quot;]
</code></pre>
<h3 id="net-aspire">.NET Aspire</h3>
<p>Optimized for .NET Aspire:</p>
<pre><code class="lang-csharp">builder.AddDdapApi(&quot;api&quot;)
       .WithReference(db)
       .WithRestApi()
       .WithAutoRefresh(30);
</code></pre>
<h2 id="future-architecture-considerations">Future Architecture Considerations</h2>
<h3 id="planned-enhancements">Planned Enhancements</h3>
<ol>
<li><p><strong>Enhanced Source Generators</strong></p>
<ul>
<li>More compile-time code generation</li>
<li>Reduced runtime overhead</li>
</ul>
</li>
<li><p><strong>Dynamic Proto File Endpoints</strong></p>
<ul>
<li>gRPC clients can download .proto files</li>
<li>Automatic client generation</li>
</ul>
</li>
<li><p><strong>REST from gRPC</strong></p>
<ul>
<li>Generate REST endpoints from gRPC services</li>
<li>Unified service definitions</li>
</ul>
</li>
<li><p><strong>Advanced Query Engine</strong></p>
<ul>
<li>OData-like filtering</li>
<li>Complex sorting and pagination</li>
</ul>
</li>
<li><p><strong>Real-time Subscriptions</strong></p>
<ul>
<li>GraphQL subscriptions</li>
<li>SignalR integration</li>
<li>WebSocket support</li>
</ul>
</li>
</ol>
<h2 id="conclusion">Conclusion</h2>
<p>DDAP's architecture prioritizes:</p>
<ul>
<li><strong>Modularity</strong>: Use only what you need</li>
<li><strong>Extensibility</strong>: Easy to customize and extend</li>
<li><strong>Performance</strong>: Efficient metadata loading and caching</li>
<li><strong>Maintainability</strong>: Clear separation of concerns</li>
<li><strong>Testability</strong>: Interface-based design</li>
</ul>
<p>For more details, see:</p>
<ul>
<li><a href="get-started.html">Get Started</a></li>
<li><a href="advanced.html">Advanced Usage</a></li>
<li><a href="api-providers.html">API Providers</a></li>
<li><a href="database-providers.html">Database Providers</a></li>
</ul>

</article>

        <div class="contribution d-print-none">
          <a href="https://github.com/schivei/ddap/blob/main/docs/architecture.md/#L1" class="edit-link">Edit this page</a>
        </div>

        <div class="next-article d-print-none border-top" id="nextArticle"></div>

      </div>

      <div class="affix">
        <nav id="affix"></nav>
      </div>
    </main>

    <div class="container-xxl search-results" id="search-results"></div>

    <footer class="border-top text-secondary">
      <div class="container-xxl">
        <div class="flex-fill">
          DDAP - Dynamic Data API Provider | MIT License
        </div>
      </div>
    </footer>
  </body>
</html>
