name: Documentation

on:
  push:
    branches: [ main ]
    paths:
      - 'docs/**'
      - 'README.md'
      - 'CONTRIBUTING.md'
      - '.github/workflows/docs.yml'
  workflow_dispatch:

env:
  DOTNET_VERSION: '10.0.x'

jobs:
  build-docs:
    name: Build and Deploy Documentation
    runs-on: ubuntu-latest
    
    permissions:
      contents: write
      pages: write
      id-token: write
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: ${{ env.DOTNET_VERSION }}

    - name: Setup DocFX
      run: dotnet tool install -g docfx

    - name: Restore and Build projects
      run: |
        dotnet restore
        dotnet build --configuration Release --no-restore
      continue-on-error: false

    - name: Generate API documentation from XML comments
      run: |
        mkdir -p docs/api
        docfx metadata docs/docfx.json
      continue-on-error: false

    - name: Build documentation site with DocFX
      run: |
        docfx build docs/docfx.json
      continue-on-error: false

    - name: Copy markdown files
      run: |
        cp docs/*.md docs/_site/ 2>/dev/null || true
        cp README.md docs/_site/ 2>/dev/null || true
        cp CONTRIBUTING.md docs/_site/ 2>/dev/null || true

    - name: Create HTML wrappers for markdown files
      run: |
        for mdfile in docs/*.md; do
          if [ -f "$mdfile" ]; then
            basename=$(basename "$mdfile" .md)
            cat > "docs/_site/${basename}.html" <<'HTMLEOF'
        <!DOCTYPE html>
        <html lang="en">
        <head>
            <meta charset="UTF-8">
            <meta name="viewport" content="width=device-width, initial-scale=1.0">
            <title>DDAP Documentation</title>
            <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/github-markdown-css/5.5.1/github-markdown.min.css">
            <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
            <style>
                body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: #f6f8fa; margin: 0; padding: 0; }
                .header { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
                .header-content { max-width: 1200px; margin: 0 auto; display: flex; align-items: center; justify-content: space-between; }
                .header h1 { margin: 0; font-size: 1.8em; }
                .nav-links a { color: white; text-decoration: none; margin-left: 20px; opacity: 0.9; }
                .nav-links a:hover { opacity: 1; }
                .container { max-width: 1200px; margin: 40px auto; padding: 0 20px; }
                .markdown-body { background: white; padding: 40px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
                .back-link { display: inline-block; margin-bottom: 20px; color: #667eea; text-decoration: none; }
                .back-link:hover { text-decoration: underline; }
                /* Contrast fix for light mode - WCAG 4.5:1 compliance */
                @media (prefers-color-scheme: light), (prefers-color-scheme: no-preference) {
                    .markdown-body { color: #24292f !important; }
                    .markdown-body p, .markdown-body li, .markdown-body td, .markdown-body th, .markdown-body dd, .markdown-body dt { color: #24292f !important; }
                    .markdown-body h1, .markdown-body h2, .markdown-body h3, .markdown-body h4, .markdown-body h5, .markdown-body h6 { color: #1f2328 !important; }
                    .markdown-body a { color: #0969da !important; }
                    .markdown-body code { color: #1f2328 !important; background-color: rgba(175,184,193,0.2) !important; }
                    .markdown-body pre code { color: #e6edf3 !important; }
                    .markdown-body blockquote { color: #59636e !important; }
                    .markdown-body strong, .markdown-body b { color: #1f2328 !important; }
                }
            </style>
        </head>
        <body>
            <div class="header">
                <div class="header-content">
                    <h1>üöÄ DDAP Documentation</h1>
                    <div class="nav-links">
                        <a href="index.html">Home</a>
                        <a href="api/">API Reference</a>
                        <a href="https://github.com/schivei/ddap">GitHub</a>
                    </div>
                </div>
            </div>
            <div class="container">
                <a href="index.html" class="back-link">‚Üê Back to Documentation</a>
                <div class="markdown-body" id="content">Loading...</div>
            </div>
            <script>
                fetch('MDFILE.md')
                    .then(r => r.ok ? r.text() : Promise.reject())
                    .then(md => { document.getElementById('content').innerHTML = marked.parse(md); })
                    .catch(() => { document.getElementById('content').innerHTML = '<h1>Error</h1><p>Could not load document.</p>'; });
            </script>
        </body>
        </html>
        HTMLEOF
            sed -i "s/MDFILE/${basename}/g" "docs/_site/${basename}.html"
          fi
        done

    - name: Create index page
      run: |
        cat > docs/_site/index.html <<'INDEXEOF'
        <!DOCTYPE html>
        <html lang="en">
        <head>
            <title>DDAP Documentation - Dynamic Data API Provider</title>
            <meta charset="utf-8">
            <meta name="viewport" content="width=device-width, initial-scale=1">
            <meta name="description" content="DDAP automatically generates REST, gRPC, and GraphQL APIs from your database schema">
            <style>
                * { box-sizing: border-box; margin: 0; padding: 0; }
                body { 
                    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
                    line-height: 1.6;
                    color: #24292f;
                    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                    min-height: 100vh;
                    padding: 20px;
                }
                .container {
                    max-width: 900px;
                    margin: 0 auto;
                    background: white;
                    border-radius: 10px;
                    box-shadow: 0 10px 40px rgba(0,0,0,0.2);
                    overflow: hidden;
                }
                .header {
                    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                    color: white;
                    padding: 40px;
                    text-align: center;
                }
                .header h1 { font-size: 2.5em; margin-bottom: 10px; }
                .header p { font-size: 1.2em; opacity: 0.9; }
                .content { padding: 40px; }
                .nav-section {
                    display: grid;
                    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
                    gap: 20px;
                    margin: 30px 0;
                }
                .nav-card {
                    padding: 25px;
                    background: #f8f9fa;
                    border-radius: 8px;
                    border-left: 4px solid #667eea;
                    transition: transform 0.2s, box-shadow 0.2s;
                }
                .nav-card:hover {
                    transform: translateY(-5px);
                    box-shadow: 0 5px 20px rgba(0,0,0,0.1);
                }
                .nav-card h3 { color: #667eea; margin-bottom: 10px; font-size: 1.3em; }
                .nav-card p { color: #57606a; margin-bottom: 15px; }
                .nav-card a {
                    display: inline-block;
                    padding: 8px 16px;
                    background: #667eea;
                    color: white;
                    text-decoration: none;
                    border-radius: 5px;
                    font-size: 0.9em;
                    transition: background 0.2s;
                }
                .nav-card a:hover { background: #764ba2; }
                .section { margin: 30px 0; }
                .section h2 {
                    color: #667eea;
                    margin-bottom: 15px;
                    padding-bottom: 10px;
                    border-bottom: 2px solid #f0f0f0;
                }
                .features {
                    display: grid;
                    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
                    gap: 15px;
                    margin: 20px 0;
                }
                .feature {
                    padding: 15px;
                    background: #f8f9fa;
                    border-radius: 5px;
                    text-align: center;
                }
                .feature strong { color: #667eea; display: block; margin-bottom: 5px; }
                code {
                    background: #f4f4f4;
                    padding: 2px 6px;
                    border-radius: 3px;
                    font-family: 'Courier New', monospace;
                    font-size: 0.9em;
                }
                pre {
                    background: #2d2d2d;
                    color: #f8f8f2;
                    padding: 20px;
                    border-radius: 5px;
                    overflow-x: auto;
                    margin: 15px 0;
                }
                pre code { background: none; color: inherit; padding: 0; }
                .badges { margin: 20px 0; text-align: center; }
                .badges img { margin: 0 5px; }
                footer {
                    text-align: center;
                    padding: 20px;
                    background: #f8f9fa;
                    color: #666;
                    font-size: 0.9em;
                }
            </style>
        </head>
        <body>
            <div class="container">
                <div class="header">
                    <h1>üöÄ DDAP</h1>
                    <p>Dynamic Data API Provider for .NET</p>
                </div>
                
                <div class="content">
                    <div class="badges">
                        <a href="https://github.com/schivei/ddap/actions"><img src="https://github.com/schivei/ddap/actions/workflows/build.yml/badge.svg" alt="Build Status"></a>
                        <a href="https://www.nuget.org/packages?q=ddap"><img src="https://img.shields.io/nuget/v/Ddap.Core.svg" alt="NuGet"></a>
                        <a href="https://github.com/schivei/ddap/blob/main/LICENSE"><img src="https://img.shields.io/github/license/schivei/ddap" alt="License"></a>
                    </div>

                    <div class="section">
                        <h2>üìö Documentation Guides</h2>
                        <div class="nav-section">
                            <div class="nav-card">
                                <h3>üéØ Get Started</h3>
                                <p>Learn the basics and create your first DDAP API in minutes</p>
                                <a href="get-started.html">Start Tutorial ‚Üí</a>
                            </div>
                            <div class="nav-card">
                                <h3>üìñ API Reference</h3>
                                <p>Complete API documentation generated from XML comments</p>
                                <a href="api/">Browse API ‚Üí</a>
                            </div>
                            <div class="nav-card">
                                <h3>üèóÔ∏è Architecture</h3>
                                <p>Understand DDAP's design, components, and how everything works together</p>
                                <a href="architecture.html">View Architecture ‚Üí</a>
                            </div>
                            <div class="nav-card">
                                <h3>üîß Advanced Usage</h3>
                                <p>Extensibility, custom endpoints, and advanced patterns</p>
                                <a href="advanced.html">Advanced Guide ‚Üí</a>
                            </div>
                            <div class="nav-card">
                                <h3>üóÑÔ∏è Database Providers</h3>
                                <p>SQL Server, MySQL, PostgreSQL, and Entity Framework support</p>
                                <a href="database-providers.html">Database Docs ‚Üí</a>
                            </div>
                            <div class="nav-card">
                                <h3>üåê API Providers</h3>
                                <p>REST, gRPC, and GraphQL API implementation details</p>
                                <a href="api-providers.html">API Docs ‚Üí</a>
                            </div>
                            <div class="nav-card">
                                <h3>üêõ Troubleshooting</h3>
                                <p>Common issues, solutions, and debugging tips</p>
                                <a href="troubleshooting.html">Get Help ‚Üí</a>
                            </div>
                        </div>
                    </div>

                    <div class="section">
                        <h2>‚ú® Features</h2>
                        <div class="features">
                            <div class="feature">
                                <strong>üöÄ Auto API Generation</strong>
                                <p>Load database schema and create endpoints automatically</p>
                            </div>
                            <div class="feature">
                                <strong>üóÑÔ∏è Multi-Database</strong>
                                <p>SQL Server, MySQL, PostgreSQL</p>
                            </div>
                            <div class="feature">
                                <strong>üåê Multi-Protocol</strong>
                                <p>REST, gRPC, GraphQL</p>
                            </div>
                            <div class="feature">
                                <strong>üìã Content Negotiation</strong>
                                <p>JSON, XML, YAML support</p>
                            </div>
                            <div class="feature">
                                <strong>üîß Extensible</strong>
                                <p>Partial classes for customization</p>
                            </div>
                            <div class="feature">
                                <strong>üì¶ Modular</strong>
                                <p>Separate libraries per provider</p>
                            </div>
                        </div>
                    </div>

                    <div class="section">
                        <h2>‚ö° Quick Start</h2>
                        <p>Install the packages:</p>
                        <pre><code>dotnet add package Ddap.Core
        dotnet add package Ddap.Data.Dapper.SqlServer
        dotnet add package Ddap.Rest
        dotnet add package Ddap.GraphQL</code></pre>
                        
                        <p>Configure in Program.cs:</p>
                        <pre><code>builder.Services
            .AddDdap(options => {
                options.ConnectionString = "Server=localhost;Database=MyDb;...";
            })
            .AddSqlServerDapper()
            .AddRest()
            .AddGraphQL();</code></pre>
                    </div>

                    <div class="section">
                        <h2>üîó Additional Resources</h2>
                        <ul style="list-style: none; padding: 0;">
                            <li style="padding: 10px; background: #f8f9fa; margin: 5px 0; border-radius: 5px;">
                                <a href="https://github.com/schivei/ddap" style="color: #667eea; text-decoration: none;">üìÇ GitHub Repository</a>
                            </li>
                            <li style="padding: 10px; background: #f8f9fa; margin: 5px 0; border-radius: 5px;">
                                <a href="https://github.com/schivei/ddap/tree/main/examples" style="color: #667eea; text-decoration: none;">üí° Example Projects</a>
                            </li>
                            <li style="padding: 10px; background: #f8f9fa; margin: 5px 0; border-radius: 5px;">
                                <a href="https://www.nuget.org/packages?q=ddap" style="color: #667eea; text-decoration: none;">üì¶ NuGet Packages</a>
                            </li>
                            <li style="padding: 10px; background: #f8f9fa; margin: 5px 0; border-radius: 5px;">
                                <a href="README.html" style="color: #667eea; text-decoration: none;">üìñ README</a>
                            </li>
                            <li style="padding: 10px; background: #f8f9fa; margin: 5px 0; border-radius: 5px;">
                                <a href="CONTRIBUTING.html" style="color: #667eea; text-decoration: none;">ü§ù Contributing Guide</a>
                            </li>
                        </ul>
                    </div>
                </div>
                
                <footer>
                    <p>DDAP - Dynamic Data API Provider | MIT License | ¬© 2026</p>
                    <p>Built with ‚ù§Ô∏è for the .NET community</p>
                </footer>
            </div>
        </body>
        </html>
        INDEXEOF

    - name: Upload to GitHub Pages
      uses: actions/upload-pages-artifact@v3
      if: github.event_name == 'push' && github.ref == 'refs/heads/main'
      with:
        path: docs/_site
      continue-on-error: true

    - name: Deploy to GitHub Pages
      id: deployment
      if: github.event_name == 'push' && github.ref == 'refs/heads/main'
      uses: actions/deploy-pages@v4
      continue-on-error: true
    
    - name: Summary
      run: |
        echo "## Documentation Build Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "‚úÖ Documentation files created successfully" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### Generated Files:" >> $GITHUB_STEP_SUMMARY
        echo "- üìÑ index.html (main page)" >> $GITHUB_STEP_SUMMARY
        echo "- üìö get-started.md" >> $GITHUB_STEP_SUMMARY
        echo "- üèóÔ∏è architecture.md" >> $GITHUB_STEP_SUMMARY
        echo "- üîß advanced.md" >> $GITHUB_STEP_SUMMARY
        echo "- üóÑÔ∏è database-providers.md" >> $GITHUB_STEP_SUMMARY
        echo "- üåê api-providers.md" >> $GITHUB_STEP_SUMMARY
        echo "- üêõ troubleshooting.md" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        if [ "${{ steps.deployment.outcome }}" == "success" ]; then
          echo "üöÄ **Deployed to GitHub Pages successfully!**" >> $GITHUB_STEP_SUMMARY
        else
          echo "‚ö†Ô∏è GitHub Pages deployment skipped or failed (make sure GitHub Pages is enabled in repository settings)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "To enable: https://github.com/schivei/ddap/settings/pages" >> $GITHUB_STEP_SUMMARY
        fi
