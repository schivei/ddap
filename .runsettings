<?xml version="1.0" encoding="utf-8"?>
<RunSettings>
  <!-- Configuration for code coverage -->
  <DataCollectionRunSettings>
    <DataCollectors>
      <DataCollector friendlyName="XPlat Code Coverage">
        <Configuration>
          <!-- Coverage options -->
          <Format>cobertura</Format>
          
          <Exclude>
            <!-- Exclude test assemblies -->
            [*.Tests]*
            [*.Tests.*]*
            
            <!-- Exclude example projects -->
            [Ddap.Example.*]*
            [*.Example.*]*
            
            <!-- Exclude code generated by EXTERNAL libraries (not our code) -->
            [*]*.g.cs
            [*]*Reflection*
            
            <!-- Exclude protobuf generated code (generated by Google.Protobuf) -->
            [Ddap.Grpc]Ddap.Grpc.RawQuery.MultipleResult
            [Ddap.Grpc]Ddap.Grpc.RawQuery.RawqueryReflection
            [Ddap.Grpc]Ddap.Grpc.RawQuery.RawQueryRequest
            [Ddap.Grpc]Ddap.Grpc.RawQuery.RawQueryService
            [Ddap.Grpc]Ddap.Grpc.RawQuery.ScalarResult
            [Ddap.Grpc]Ddap.Grpc.RawQuery.SingleResult
            [Ddap.Grpc]Ddap.Grpc.RawQuery.VoidResult
            
            <!-- Note: Ddap.CodeGen is OUR source generator and SHOULD be tested -->
            
            <!-- Exclude E2E-only code (requires running servers, tested via integration/E2E tests) -->
            <!-- REST Controllers - require ASP.NET Core server -->
            [*]*Controller
            [Ddap.Rest]*Controller*
            [Ddap.GraphQL]*Controller*
            
            <!-- gRPC Services - require gRPC server -->
            [*]*ServiceImpl
            [Ddap.Grpc]*Service.cs
            [Ddap.Grpc]Ddap.Grpc.Services.*
            
            <!-- Dependency Injection Extensions - require DI container -->
            [*]*ServiceExtensions
            [*]*ServiceCollectionExtensions
            [Ddap.Aspire]Ddap.Aspire.DdapServiceExtensions
            [Ddap.Client.Core]Ddap.Client.Core.DdapClientServiceCollectionExtensions
            [Ddap.Client.GraphQL]Ddap.Client.GraphQL.DdapGraphQLClientServiceCollectionExtensions
            [Ddap.Client.Grpc]Ddap.Client.Grpc.DdapGrpcClientServiceCollectionExtensions
            [Ddap.Client.Rest]Ddap.Client.Rest.DdapRestClientServiceCollectionExtensions
            [Ddap.Core]Ddap.Core.DdapServiceCollectionExtensions
            
            <!-- Middleware and Pipeline - require ASP.NET Core pipeline -->
            [*]*Middleware
            [*]*Pipeline*
            
            <!-- Specific E2E-only files -->
            [Ddap.Grpc]Ddap.Grpc.RawQueryServiceExtensions
            [Ddap.Grpc]Ddap.Grpc.Services.RawQueryServiceImpl
            [Ddap.Grpc]Ddap.Grpc.EntityService
            [Ddap.Rest]Ddap.Rest.EntityController*
            [Ddap.Auth]Ddap.Auth.Attributes.DdapAuthorizeAttribute
            [Ddap.Auth]Ddap.Auth.DdapAuthExtensions
            
            <!-- Exclude specific files -->
            [*]*AssemblyInfo*
            [*]*AssemblyAttributes*
            
            <!-- Exclude Templates (not application code) -->
            [Ddap.Templates]*
            
            <!-- Exclude internal configuration classes -->
            [Ddap.Core]Ddap.Core.Internals.*
            [Ddap.Core]Ddap.Core.AutoReloadOptions
          </Exclude>
          
          <!-- Include main application code (unit-testable business logic) -->
          <Include>
            [Ddap.Core]*
            [Ddap.Rest]*
            [Ddap.GraphQL]*
            [Ddap.Grpc]*
            [Ddap.Aspire]*
            [Ddap.Client.Core]*
            [Ddap.Client.Rest]*
            [Ddap.Client.GraphQL]*
            [Ddap.Client.Grpc]*
            [Ddap.Data.EntityFramework]*
            [Ddap.Data.Dapper]*
            [Ddap.Auth]*
            [Ddap.CodeGen]*
            [Ddap.Subscriptions]*
          </Include>
          
          <!-- Include private and internal members in coverage -->
          <IncludeTestAssembly>false</IncludeTestAssembly>
          
          <!-- Use source link -->
          <UseSourceLink>true</UseSourceLink>
          
          <!-- Single hit -->
          <SingleHit>false</SingleHit>
          
          <!-- Include directories -->
          <IncludeDirectory>../../../</IncludeDirectory>
          
          <!-- Skip auto props -->
          <SkipAutoProps>true</SkipAutoProps>
          
          <!-- Deterministic report -->
          <DeterministicReport>true</DeterministicReport>
        </Configuration>
      </DataCollector>
    </DataCollectors>
  </DataCollectionRunSettings>
  
  <!-- Test framework settings -->
  <RunConfiguration>
    <MaxCpuCount>0</MaxCpuCount>
    <ResultsDirectory>./coverage</ResultsDirectory>
    <CollectSourceInformation>true</CollectSourceInformation>
  </RunConfiguration>
</RunSettings>
